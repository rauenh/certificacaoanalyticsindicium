with
    salesorderheader as (
        select
            salesorderid
            , subtotal
            , taxamt
            , freight
            , totaldue
            , cast(orderdate as datetime) as orderdate
            , status as status_sales
            , customerid
            , shiptoaddressid
            , territoryid
            , creditcardid
        from {{ source('stg_raw_salesorderheader') }}
    ),
    address as (
        select
            addressid
            , city
            , stateprovinceid
        from {{source('stg_raw_address')}}
    ),
    stateprovince as (
        select
            stateprovinceid
            , name as name_state
            , countryregioncode
            from {{source('stg_raw_stateprovince')}}
    ),
    countryregion as (
        select
            countryregioncode
            , name as name_country
            from {{source('stg_raw_countryregion')}}
    )
    customer as (
            customerid
            , personid
            , territoryid
        from {{ref('stg_raw_customer')}}
    ),
    businessentitycontact as (
        select
            businessentityid
            , personid
        from {{ref('stg_raw_businessentitycontact')}}
    ),
    person as (
            businessentityid
            , persontype
            , firstname
            , middlename
            , lastname
        from {{(ref ('stg_raw_person'))}}
    ),
    join_customer as (
        select
            customer.customerid
            , customer.personid
            , businessentitycontact.businessentityid
            , CASE
                WHEN person.persontype = 'SC' THEN 'Store Contact'
                WHEN person.persontype = 'IN' THEN 'Individual Customer'
                WHEN person.persontype = 'SP' THEN 'Sales Person'
                WHEN person.persontype = 'EM' THEN 'Employee'
                WHEN person.persontype = 'VC' THEN 'Vendor'
                WHEN person.persontype = 'GC' THEN 'General Contact'
            end as persontype,
            , person.firstname
            , person.middlename
            , person.lastname
        from customer
        left join businessentitycontact on (customer.customerid = businessentitycontact.customerid)
        left join businessentitycontact on (customer.personid = businessentitycontact.personid)
        left join person on ( businessentitycontact.personid = person.businessentityid)
    )
select *
from join_customer